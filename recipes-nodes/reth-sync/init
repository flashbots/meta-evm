#!/bin/sh
### BEGIN INIT INFO
# Provides:          reth-sync
# Required-Start:    $network $remote_fs
# Required-Stop:     $network $remote_fs
# Default-Start:     5
# Default-Stop:      0 1 6
# Short-Description: Sync data using rclone
# Description:       Runs rclone sync script to synchronize data from R2 storage
### END INIT INFO

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DESC="Rclone Sync Service"
NAME=reth-sync
LOGFILE=/var/log/reth-sync.log
RCLONE_CONFIG=/etc/rclone.conf
RETH_DIR=/persistent/reth
RETH_USER=reth
ETH_GROUP=eth

log() {
    echo "$(date): $1" >> "$LOGFILE"
    echo "$1" > /var/volatile/system-api.fifo
}

start() {
    log "Starting $DESC"

    # Ensure the reth-sync log file exists and has correct permissions
    touch "$LOGFILE"
    chown "$RETH_USER:$ETH_GROUP" "$LOGFILE"

    # Ensure the RETH_DIR exists and has correct permissions
    mkdir -p "$RETH_DIR"
    chown "$RETH_USER:$ETH_GROUP" "$RETH_DIR"

    # Run the sync process as the reth user
    BASE_SNAPSHOT_URL="https://snapshots.flashbots.dev/reth-mainnet-full"
    LATEST_VERSION=$(rclone copyurl "$BASE_SNAPSHOT_URL/latest_version.meta.txt" - 2>> "$LOGFILE")
    log "Latest version: $LATEST_VERSION"

    rclone copyurl "$BASE_SNAPSHOT_URL/$LATEST_VERSION/files.txt" files.txt >> "$LOGFILE" 2>&1

    log "Starting rclone copy"
    rclone copy --progress --transfers 20 --multi-thread-streams 30 \
        --http-url "$BASE_SNAPSHOT_URL/$LATEST_VERSION" --no-traverse --http-no-head \
        --disable-http2 --inplace --no-gzip-encoding --size-only --retries 6 \
        --retries-sleep 10s --files-from files.txt :http: "$RETH_DIR" >> "$LOGFILE" 2>&1

    rm files.txt
    log "Reth is synced with the latest meta version: $LATEST_VERSION"

    chown -R "$RETH_USER:$ETH_GROUP" "$RETH_DIR"
}

case "$1" in
    start)
        start
        ;;
    *)
        echo "Usage: $0 start" >&2
        exit 1
        ;;
esac

exit 0
